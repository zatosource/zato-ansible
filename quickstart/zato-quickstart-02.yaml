
- name: Update and upgrade apt packages (02)
  apt:
    upgrade: yes
    update_cache: yes
    cache_valid_time: 3600

- name: Install NodeJS (for testing) (02)
  when: zato_run_internal_tests
  shell: |
    curl -sL https://deb.nodesource.com/setup_17.x | bash -
    apt-get install -y nodejs

- name: Make sure that PostgreSQL is started (02)
  when: zato_use_postgresql
  shell: |
    DEBIAN_FRONTEND=noninteractive service postgresql restart

- name: Make sure that MySQL is started (02)
  when: zato_use_mysql
  shell: |
    DEBIAN_FRONTEND=noninteractive service mysql restart

- name: Make sure that Redis is started (02)
  shell: |
    DEBIAN_FRONTEND=noninteractive service redis-server restart

- name: Regenerate host SSH keys (02)
  shell: |
    rm -v /etc/ssh/ssh_host_*
    DEBIAN_FRONTEND=noninteractive dpkg-reconfigure openssh-server

- name: Restart the SSH server after regenerating its keys (02)
  shell: |
    DEBIAN_FRONTEND=noninteractive service ssh restart

- name: Drop the SQL database if it exists (PG -> main) (02)
  when: zato_use_postgresql
  become: true
  become_user: "postgres"
  community.postgresql.postgresql_db:
    state: absent
    force: "yes"
    name: "{{ zato_db_main }}"

- name: Drop the SQL database if it exists (MySQL -> main) (02)
  when: zato_use_mysql
  community.mysql.mysql_db:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    state: absent
    force: "yes"
    name: "{{ zato_db_main }}"

- name: Drop the SQL database if it exists (PG -> pub/sub) (02)
  when: zato_use_postgresql
  become: true
  become_user: "postgres"
  community.postgresql.postgresql_db:
    state: absent
    force: "yes"
    name: "{{ zato_db_pubsub }}"

- name: Drop the SQL database if it exists (MySQL -> pub/sub) (02)
  when: zato_use_mysql
  community.mysql.mysql_db:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    state: absent
    force: "yes"
    name: "{{ zato_db_pubsub }}"

- name: Create the SQL database (PG -> main) (02)
  when: zato_use_postgresql
  become: true
  become_user: "postgres"
  community.postgresql.postgresql_db:
    state: present
    encoding: UTF-8
    lc_collate: en_US.UTF-8
    lc_ctype: en_US.UTF-8
    template: template0
    name: "{{ zato_db_main }}"

- name: Create the SQL database (MySQL -> main) (02)
  when: zato_use_mysql
  community.mysql.mysql_db:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    state: present
    force: "yes"
    name: "{{ zato_db_main }}"

- name: Create the SQL database (PG -> pub/sub) (02)
  when: zato_use_postgresql
  become: true
  become_user: "postgres"
  community.postgresql.postgresql_db:
    state: present
    encoding: UTF-8
    lc_collate: en_US.UTF-8
    lc_ctype: en_US.UTF-8
    template: template0
    name: "{{ zato_db_pubsub }}"

- name: Create the SQL database (MySQL -> pub/sub) (02)
  when: zato_use_mysql
  community.mysql.mysql_db:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    state: present
    force: "yes"
    name: "{{ zato_db_pubsub }}"

- name: Drop the SQL user if it exists (PG -> main) (02)
  when: zato_use_postgresql
  become: true
  become_user: "postgres"
  community.postgresql.postgresql_user:
    state: absent
    fail_on_user: "no"
    name: "{{ zato_db_username_main }}"

- name: Drop the SQL user if it exists (MySQL -> main) (02)
  when: zato_use_mysql
  community.mysql.mysql_db:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    state: absent
    name: "{{ zato_db_username_main }}"

- name: Drop the SQL user if it exists (PG -> pub/sub) (02)
  when: zato_use_postgresql
  become: true
  become_user: "postgres"
  community.postgresql.postgresql_user:
    state: absent
    fail_on_user: "no"
    name: "{{ zato_db_username_pubsub }}"

- name: Drop the SQL user if it exists (MySQL -> pub/sub) (02)
  when: zato_use_mysql
  community.mysql.mysql_db:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    state: absent
    name: "{{ zato_db_username_pubsub }}"

- name: Create the SQL user (PG -> main) (02)
  when: zato_use_postgresql
  become: true
  become_user: "postgres"
  community.postgresql.postgresql_user:
    state: present
    db: "{{ zato_db_main }}"
    name: "{{ zato_db_username_main }}"
    password: "{{ zato_db_password_main }}"
    encrypted: "yes"
    priv: "ALL"
    comment: "Main Zato user for PostgreSQL"

- name: Create the SQL user (MySQL -> main) (02)
  when: zato_use_mysql
  community.mysql.mysql_user:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    state: present
    name: "{{ zato_db_username_main }}"
    password: "{{ zato_db_password_main }}"
    priv: '*.*:ALL,GRANT'

- name: Create the SQL user (PG -> pub/sub) (02)
  when: zato_use_postgresql
  become: true
  become_user: "postgres"
  community.postgresql.postgresql_user:
    state: present
    db: "{{ zato_db_pubsub }}"
    name: "{{ zato_db_username_pubsub }}"
    password: "{{ zato_db_password_pubsub }}"
    encrypted: "yes"
    priv: "ALL"
    comment: "Zato publish/subscribe user for PostgreSQL"

- name: Create the SQL user (MySQL -> pub/sub) (02)
  when: zato_use_mysql
  community.mysql.mysql_user:
    login_unix_socket: /var/run/mysqld/mysqld.sock
    state: present
    name: "{{ zato_db_username_pubsub }}"
    password: "{{ zato_db_password_pubsub }}"
    priv: '*.*:ALL,GRANT'

- name: Grant access to the SQL user (PG -> main) (02)
  when: zato_use_postgresql
  community.postgresql.postgresql_pg_hba:
    create: "yes"
    dest: "{{ pg_hba_conf_path }}"
    contype: host
    users: "{{ zato_db_username_main }}"
    source: all
    databases: "{{ zato_db_main }}, postgres"
    method: md5

- name: Grant access to the SQL user (PG -> pub/sub) (02)
  when: zato_use_postgresql
  community.postgresql.postgresql_pg_hba:
    create: "yes"
    dest: "{{ pg_hba_conf_path }}"
    contype: host
    users: "{{ zato_db_username_pubsub }}"
    source: all
    databases: "{{ zato_db_pubsub }}, postgres"
    method: md5

- name: Configure PostgreSQL to listen on all interfaces (02)
  when: zato_use_postgresql
  replace:
    path: "{{ pg_conf_path }}"
    regexp: "#listen_addresses = 'localhost'"
    replace: "listen_addresses = '*'"

- name: Enable password-based SSH connections (02)
  replace:
    path: "/etc/ssh/sshd_config"
    regexp: "PasswordAuthentication no"
    replace: "PasswordAuthentication yes"

- name: Allow for SSH connections to be established from anywhere (02)
  replace:
    path: "/etc/ssh/sshd_config"
    regexp: "#ListenAddress 0.0.0.0"
    replace: "ListenAddress 0.0.0.0"

- name: Restart PostgreSQL after its configuration was changed (02)
  when: zato_use_postgresql
  shell: |
    DEBIAN_FRONTEND=noninteractive service postgresql restart

- name: Restart MySQL after its configuration was changed (02)
  when: zato_use_mysql
  shell: |
    DEBIAN_FRONTEND=noninteractive service mysql restart

- name: Restart the SSH server after its configuration was changed (02)
  shell: |
    DEBIAN_FRONTEND=noninteractive service ssh restart

- name: Set the SSH password for user 'zato' (02)
  user:
    name: zato
    password: "{{ zato_ssh_user_password | password_hash('sha512') }}"

- name: Install HashiCorp Vault (02)
  when: zato_use_hashicorp_vault
  become: true
  become_user: "root"
  shell: |
    curl -fsSL https://apt.releases.hashicorp.com/gpg | apt-key add -
    apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
    apt-get update && apt-get install vault

- name: Make sure all the previous processes started by user zato are stopped (02)
  shell: |
    pkill --signal 9 -u zato || true

- name: Start HashiCorp Vault (dev) (02)
  when: zato_use_hashicorp_vault
  become: true
  become_user: "zato"
  shell: |
    /usr/bin/vault server -dev -dev-root-token-id={{ zato_hashicorp_vault_token }}
  async: "{{ zato_async_timeout }}"
  poll: 0

- name: Make sure any previous environment is deleted (02)
  shell: |
    rm -rf {{ zato_env_path }}
